#!/bin/bash

filename="$HOME/.calories"

if [ ! -f "$filename" ]; then
  touch "$filename"
fi

if [ $# -eq 0 ]; then
  "$0" add
  exit 0
fi

case "$1" in
  "add")
    food=$(awk -F'\t' '
      { print $2 }
    ' "$filename" | sort | uniq | fzf --print-query | tail -n 1)

    if [ -z "$food" ]; then
      echo "No food selected"
      exit 1
    fi

    date=$(date +%Y-%m-%d)
    calories=0
    protein=0

    read -r -p "Calories: " calories
    if [ -z "$calories" ]; then
      echo "No calories entered"
      exit 1
    fi

    read -r -p "Protein: " protein
    if [ -z "$protein" ]; then
      echo "No protein entered"
      exit 1
    fi

    read -r -p "Servings: " servings
    if [ -z "$servings" ]; then
      echo "No servings entered"
      exit 1
    fi

    echo "$date	$food	$servings	$calories	$protein" >> "$filename"
    "$0" show
    ;;
  "summary")
    firstLine=$(head -n 1 "$filename")
    startDay=$(echo "$firstLine" | awk -F'\t' '{ print $1 }')
    startEpoch=$(date -d "$startDay" +%s)
    currentEpoch=$(date +%s)

    awk -F'\t' -v startEpoch="$startEpoch" -v currentEpoch="$currentEpoch" '
      BEGIN {
        calories = 0
        today = 0
      }
      {
        servings = $3
        calories += $4 * servings
      }
      /^'"$(date +%Y-%m-%d)"'/ {
        servings = $3
        today += $4 * servings
      }
      END {
        dailyCalories = 2000
        days = (currentEpoch - startEpoch) / 86400
        required = dailyCalories * days

        printf "Days:        % .4f\n", days
        printf "Calories:    % d\n", calories
        printf "  Per day:   % d\n", calories / days
        printf "  Remaining: % d\n", required - calories
        printf "  Today:     % d\n", today
    ;;
  "today")
    date=$(date +%Y-%m-%d)
    awk -F'\t' '
      BEGIN {
        total_calories = 0
        total_protein = 0
      }
      /^'"$date"'/ {
        print $0
        servings = $3
        total_calories += $4 * servings
        total_protein += $5 * servings
      }
      END {
        print ""
        print "Total calories: " total_calories
        print "Total protein: " total_protein
      }
    ' "$filename"
    ;;
  "help")
    echo "Usage: calories <command>"
    echo "Commands:"
    echo "  add - add a new entry"
    echo "  summary - show summary"
    echo "  today - show today's entries"
    echo "  help - show this help message"
    ;;
  *)
    echo "Invalid option"
    ;;
esac
